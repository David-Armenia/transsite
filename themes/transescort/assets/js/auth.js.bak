document.addEventListener('DOMContentLoaded', () => {
  // Guard: require localized settings
  if (!window.transescortAuth || !transescortAuth.ajaxurl) return;

  // Tabs
  const tabs = document.querySelectorAll('.auth-tab');
  const loginForm = document.querySelector('.js-login-form');
  const registerForm = document.querySelector('.js-register-form');

  if (tabs.length && loginForm && registerForm) {
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('is-active'));
        tab.classList.add('is-active');

        const isLogin = tab.dataset.tab === 'login';
        loginForm.style.display = isLogin ? 'block' : 'none';
        registerForm.style.display = isLogin ? 'none' : 'block';
      });
    });
  }

  async function safeJson(res) {
    const text = await res.text();
    try {
      const json = JSON.parse(text);
      // if HTTP not ok, still return json but mark as failed
      if (!res.ok && json && typeof json.success === 'undefined') {
        return { success: false, data: { message: 'Request failed.' } };
      }
      return json;
    } catch (e) {
      // console.debug('Non-JSON response:', text);
      return { success: false, data: { message: 'Server error. Invalid response.' } };
    }
  }

  function getMsg(payload, fallback) {
    return payload?.data?.message || fallback || 'Error';
  }

  function getRedirect(payload) {
    return payload?.data?.redirect || '';
  }

  function bindAjaxForm(form, actionName, fallbackError) {
    if (!form) return;

    const errorBox = form.querySelector('.auth-error');
    const submitBtn = form.querySelector('[type="submit"]');
    const originalBtnText = submitBtn ? submitBtn.textContent : '';

    if (!errorBox) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      errorBox.style.display = 'none';
      errorBox.textContent = '';

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Please wait...';
      }

      try {
        const formData = new FormData(form);
        formData.append('action', actionName);

        const res = await fetch(transescortAuth.ajaxurl, {
          method: 'POST',
          credentials: 'same-origin',
          body: formData
        });

        const payload = await safeJson(res);

        if (payload.success) {
          const redirect = getRedirect(payload) || transescortAuth.accountUrl || '/account/';
          window.location.href = redirect;
          return;
        }

        errorBox.textContent = getMsg(payload, fallbackError);
        errorBox.style.display = 'block';
      } catch (err) {
        errorBox.textContent = 'Server error. Please try again.';
        errorBox.style.display = 'block';
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        }
      }
    });
  }

  bindAjaxForm(loginForm, 'transescort_login', 'Login failed.');
  bindAjaxForm(registerForm, 'transescort_register', 'Registration failed.');
});

